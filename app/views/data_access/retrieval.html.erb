<% content_for :javascript do %>
  <script>
    this.edscPageData = <%= raw @retrieval.project.merge(id: @retrieval.to_param).to_json %>;
  </script>
  <%= javascript_include_tag "data_access" %>
<% end %>

<% content_for :toolbar_secondary do %>
  <%= render partial: 'shared/feedback' %>
  <%= render partial: 'shared/login' %>
<% end %>

<section class="data-access data-access-retrieve">
  <nav class="data-access-nav">
    <a href="<%=edsc_path "/data/configure?#{@retrieval.source}" %>"><i class="fa fa-chevron-circle-left"></i> Back to Data Access Options</a>
  </nav>
  <header class="data-access-header" data-bind="visible: ui.projectList.awaitingStatus()">
    <h1>Request in Progress</h1>
    <p>Your request is being processed.  Please standby for status.</p>
  </header>
  <div class="data-access-container">
    <section class="data-access-content data-access-downloads" data-bind="visible: ui.projectList.collectionsToDownload().length > 0">
      <h2>The following collections are available for immediate download</h2>
      <p>
        Click the "View/Download Data Links" button to view or download a file containing links to your data.
        You may bookmark this page for later access.
        A browser download manager plugin such as Firefox's
        <a class="link" href="https://addons.mozilla.org/en-US/firefox/addon/downthemall/">DownThemAll!</a>
        can assist you in managing a large number of download links.
      </p>
      <ul class="data-access-collections-list" data-bind="foreach: ui.projectList.collectionsToDownload">
        <li class="data-access-collection">
          <p class="data-access-collection-name" data-bind="text: title"></p>
          <div class="data-access-collection-actions">
            <!-- ko foreach: links -->
            <a class="button text-button" href="#" target="_blank" data-bind="text: title, attr: {href: url, title: tooltip}" data-tooltip="true" data-placement="bottom"></a>
            <!-- /ko -->
          </div>
        </li>
      </ul>
    </section>
    <section class="data-access-content data-access-collection-only" data-bind="visible: ui.projectList.collectionOnly().length > 0">
      <h2>The following collections are available on the provider's website</h2>
      <ul class="data-access-collections-list" data-bind="foreach: ui.projectList.collectionOnly">
        <li class="data-access-collection">
          <p class="data-access-collection-name" data-bind="text: collection.dataset_id"></p>
          <!-- ko foreach: (collection.hasAtomData() ? collection.links : []) -->
          <p data-bind="if: $data.rel == 'enclosure' || $data.rel.indexOf('/data') > -1">
            <a class="link" data-bind="attr: {href: $data.href}, text: edsc.util.string.capitalize($data.title)" target="_blank"></a>
          </p>
          <!-- /ko -->
        </li>
      </ul>
    </section>
    <section class="data-access-content data-access-orders" data-bind="visible: ui.projectList.submittedOrders().length > 0">
      <h2>The following collections are being processed</h2>
      <p>
        When the data becomes available, an email containing download links will be sent to the address you provided.
      </p>
      <ul class="data-access-collections-list" data-bind="foreach: ui.projectList.submittedOrders">
        <li class="data-access-collection">
          <p>
            <span class="data-access-collection-name" data-bind="text: dataset_id"></span>
            <!-- ko if: order_status -->
            <span class="order-state" data-bind="css: order_status, text: order_status"></span>
            <!-- /ko -->
          </p>
          <!-- ko if: order_status == 'failed' -->
          <%= render partial: 'access_error' %>
          <!-- /ko -->
          <div class="data-access-collection-actions">
            <!-- ko if: downloadBrowseUrl -->
            <a class="button text-button" href="#" target="_blank" data-bind="attr: {href: downloadBrowseUrl}" title="View clickable browse links in browser" data-tooltip="true" data-placement="bottom">View Browse Image Links</a>
            <!-- /ko -->
            <!-- ko if: cancel_link -->
              <a data-bind="attr: {href: cancel_link}"
                 class="button text-button"
                 data-remote="true"
                 data-method="post"
                 data-confirm="Are you sure you want to remove this order?  This action cannot be undone."
                 rel="nofollow">Cancel</a>
            <!-- /ko -->
            <!-- ko if: dropped_granules && dropped_granules.length > 0 -->
              <p>The following granules will not be processed because they do not support the <strong data-bind="text: method_name"></strong> access method:</p>
              <div class="granule-list">
                <div>
                  <ul>
                  <!--ko foreach: dropped_granules-->
                    <li>
                      <h5 data-bind="text: name"></h5>
                      <span data-bind="text: id"></span>
                    </li>
                  <!--/ko-->
                  </ul>
                </div>
              </div>
            <!-- /ko -->
          </div>
        </li>
      </ul>
    </section>
    <section class="data-access-content data-access-services" data-bind="visible: ui.projectList.submittedServiceOrders().length">
      <h2>The following collections are being processed</h2>
      <!-- ko if: ui.projectList.submittedServiceOrderTotal() == 1 -->
      <h1 data-bind="text: ui.projectList.submittedServiceOrderTotal()"></h1>
        <p>
          When the data for your order becomes available, an email containing download links will be sent to the email address you've provided. This page will automatically update as your orders are processed and can be accessed later by visiting <a class="link" href="https://search.earthdata.nasa.gov/data/retreive/0433526155">https://search.earthdata.nasa.gov/data/retreive/0433526155</a> or the <a class="link" href="/data/status/">Download Status and History</a> page.
        </p>
      <!-- /ko -->
      <!-- ko if: ui.projectList.submittedServiceOrderTotal() > 1 -->
        <p>
          Due to the size of your request, it has been split into <span data-bind="text: ui.projectList.submittedServiceOrderTotal()"></span> separate orders. When the data for each order becomes available, an email containing download links will be sent to the email address you've provided. This page will automatically update as your orders are processed and can be accessed later by visiting <a class="link" href="https://search.earthdata.nasa.gov/data/retreive/0433526155">https://search.earthdata.nasa.gov/data/retreive/0433526155</a> or the <a class="link" href="/data/status/">Download Status and History</a> page.
        </p>
      <!-- /ko -->
      <ul class="data-access-collections-list data-access-collections-list-panel" data-bind="foreach: ui.projectList.submittedServiceOrders">
        <li class="data-access-collection">
          <h3 class="data-access-collection-name" data-bind="text: dataset_id"></h3>
          <div class="data-access-collection-body">
            <!-- ko if: order_status -->
            <div class="data-access-collection-state" data-bind="css: order_status_to_classname">
              <span data-bind="text: order_status"></span>
            </div>
            <div class="data-access-collection-state-text">
              <!-- ko if: order_status == 'creating'  -->
              <p>
                Your orders are pending processing. This may take some time.
              </p>
              <!-- /ko -->
              <!-- ko if: order_status == 'in progress' -->
              <p>
                Your orders is currently processing. Once processing is finished, download links will be displayed below and sent to the email you've provided.
              </p>
              <!-- /ko -->
              <!-- ko if: order_status == 'complete' -->
              <p>
                Your orders are done processing and are available for download.
              </p>
              <!-- /ko -->
            </div>
            <!-- /ko -->
          </div>
          <div class="data-access-collection-actions">
            <!-- TODO Grab the processing percentage for the overall project -->
            <!-- ko if: order_status == 'in progress' -->
            <span class="data-access-collection-est">
              <span data-bind="text: complete_orders"></span>/<span data-bind="text: total_orders"></span> orders complete
              <span class="data-access-collection-percentage">(<span data-bind="text: percent_done"></span>%)</span>
            </span>
            <button type="button" class="button-small more-details-button" data-bind="click: $root.ui.projectList.toggleMoreDetails">
              <span data-bind="text: !is_more_details_visible() ? 'More Details' : 'Less Details'"></span>
              <i class="fa " data-bind="css: !is_more_details_visible() ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
            </button>
            <!-- TODO Condtionally enable list from button below when download links are avaiable -->
            <div class="dropdown">
              <button type="button" class="button-small dropdown-toggle"  data-toggle="dropdown" data-bind="attr: {disabled: !has_downloads_available}">
                Download Links <i class="fa fa-sort-desc"></i>
              </button>
              <ul class="dropdown-menu download-dropdown" data-bind="foreach: orders">
                <li>
                  <div class="download-dropdown-header">
                    <p>
                      Order <span data-bind="text: ($index() + 1)"></span>/<span data-bind="text: $parent.total_orders"></span>
                      <span class="download-dropdown-header-secondary">- Order ID: <span data-bind="text: order_id"></span></span>
                    </p>
                  </div>
                  <div class="download-dropdown-content">
                  <!-- ko if: download_urls.length -->
                    <ul data-bind="foreach: download_urls">
                      <li>
                        <a class="link" href="#" data-bind="text: $data, attr: { href: $data }"></a>
                      </li>
                    </ul>
                  <!-- /ko -->
                  <!-- ko ifnot: download_urls.length -->
                    <span data-bind="text: order_status"></span> (<span data-bind="text: percent_done"></span>% complete)
                  <!-- /ko -->
                  </div>
                </li>
              </ul>
            </div>
            <!-- /ko -->
            <!-- ko if: order_status == 'failed' -->
            <%= render partial: 'access_error' %>
            <!-- /ko -->
            <!-- ko if: is_more_details_visible -->
            <div class="data-access-collection-detail">
              <!-- TODO do the following for each order in the collection -->
              <ul class="data-access-services-orders" data-bind="foreach: orders">
                <li>
                  <h4 class="data-access-order-id">Order ID: <span data-bind="text: order_id"></span></h4>
                  <p>
                    <span data-bind="text: total_processed"></span> of <span data-bind="text: total_number"></span> granules processed (<span data-bind="text: percent_done"></span>%)
                    <span class="data-access-order-status" data-bind="css: order_status, text: order_status"></span>
                  </p>
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-bind="attr: { 'aria-valuenow': percent_done}, style: { width: percent_done + '%' }">
                    </div>
                  </div>
                </li>
              </ul>
              <!-- ko if: order_status == 'complete' -->
              <!-- <p>Your request is complete and can be downloaded using the following urls:</p>
              <div>
                <ul class="data-access-services-links" data-bind="foreach: download_urls">
                  <li><a class="link" data-bind="attr: {href: $data}, text: $data"></a></li>
                </ul>
              </div> -->
              <!-- /ko -->
              <!-- ko if contact -->
              <p class="data-access-collection-contact">For assistance, please contact
                <span data-bind="text: contact.name"></span> at
                <a class="link" data-bind="attr: { href: 'mailto:' + contact.email }">
                  <span data-bind="text: contact.email"></span>
                </a>
              </p>
              <!-- /ko -->
            </div>
            <!-- /ko -->
            <!-- ko if: downloadBrowseUrl -->
            <!-- TODO should be a bit of top margin here -->
            <div class="data-access-services-buttons">
              <a class="button text-button" href="#" target="_blank" data-bind="attr: {href: downloadBrowseUrl}">View Browse Image Links</a>
            </div>
            <!-- /ko -->
          </div>
        </li>
      </ul>
    </section>
    <section class="data-access-content data-access-resources" data-bind="visible: ui.projectList.collectionLinks().length > 0">
      <h2>Additional Resources and Documentation</h2>
      <ul class="data-access-collections-list" data-bind="foreach: ui.projectList.collectionLinks">
        <li class="data-access-collection">
          <p class="data-access-collection-name" data-bind="text: dataset_id"></p>
          <ul class="data-access-collection-actions" data-bind="foreach: links">
            <li><a class="link" data-bind="attr: {href: href}, text: title"></a></li>
          </ul>
        </li>
      </ul>
    </section>
  </div>
  <section class="data-access-next">
    <h2>Next Steps</h2>
    <ul>
      <li>
        <i class="fa fa-chevron-circle-right"></i> <a class="link" href="<%=edsc_path "/search?#{@retrieval.source}" %>">Back to <%= site_name %> Results</a>
      </li>
      <li>
        <i class="fa fa-chevron-circle-right"></i> <a class="link" href="<%=edsc_path "/"%>">Start a New <%= site_name %> Session</a>
      </li>
      <li>
        <i class="fa fa-chevron-circle-right"></i> <a class="link" href="<%=edsc_path '/data/status' %>">View Your Download Status & History</a>
      </li>
    </ul>
  </section>
</section>
